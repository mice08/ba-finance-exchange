<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ExchangeOrder">

    <typeAlias alias="ExchangeOrder" type="com.dianping.ba.finance.exchange.api.datas.ExchangeOrderData"/>
    <resultMap id="exchangeOrder" class="ExchangeOrder">
        <result property="exchangeOrderId" column="ExchangeOrderID"/>
        <result property="orderAmount" column="OrderAmount"/>
        <result property="orderType" column="OrderType"/>
        <result property="bankAccountNo" column="BankAccountNo"/>
        <result property="bankAccountName" column="BankAccountName"/>
        <result property="bankName" column="BankName"/>
        <result property="bankProvince" column="BankProvince"/>
        <result property="bankCity" column="BankCity"/>
        <result property="status" column="Status"/>
        <result property="addDate" column="AddDate"/>
        <result property="orderDate" column="OrderDate"/>
        <result property="lastUpdateDate" column="LastUpdateDate"/>
        <result property="memo" column="Memo"/>
    </resultMap>

    <typeAlias alias="ExchangeOrderDisplayData" type="com.dianping.ba.finance.exchange.api.datas.ExchangeOrderDisplayData"/>
    <resultMap id="exchangeOrderDisplayData" class="ExchangeOrderDisplayData">
        <result property="exchangeOrderId" column="ExchangeOrderID"/>
        <result property="customerGlobalId" column="CustomerGlobalId"/>
        <result property="companyGlobalId" column="CompanyGlobalId"/>
        <result property="shopId" column="ShopId"/>
        <result property="orderAmount" column="OrderAmount"/>
        <result property="bankAccountNo" column="BankAccountNo"/>
        <result property="bankAccountName" column="BankAccountName"/>
        <result property="bankName" column="BankName"/>
        <result property="bankProvince" column="BankProvince"/>
        <result property="bankCity" column="BankCity"/>
        <result property="status" column="Status"/>
        <result property="memo" column="Memo"/>
        <result property="addDate" column="AddDate"/>
    </resultMap>

    <insert id="insertExchangeOrder" parameterClass="map">
        <![CDATA[
        	 insert into FS_ExchangeOrder
		            (OrderAmount,
		             OrderType,
		             BankAccountNo,
		             BankAccountName,
		             BankName,
		             BankProvince,
                     BankCity,
		             AddDate,
		             LastUpdateDate,
		             Memo
		             )
			values (#exchangeOrderData.orderAmount#,
			         #exchangeOrderData.orderType#,
			         #exchangeOrderData.bankAccountNo#,
			         #exchangeOrderData.bankAccountName#,
			         #exchangeOrderData.bankName#,
			         #exchangeOrderData.bankProvince#,
			         #exchangeOrderData.bankCity#,
			         NOW(),
			         NOW(),
			         #exchangeOrderData.memo#
			        );
 		]]>
        <selectKey resultClass="java.lang.Integer" keyProperty="exchangeOrderId">
            <![CDATA[
			SELECT @@IDENTITY AS id
		]]>
        </selectKey>
    </insert>

    <update id="updateExchangeOrderData" parameterClass="map">
        UPDATE FS_ExchangeOrder
        SET Status = #postStatus#,
        <isNotEmpty property="orderDate">
            OrderDate = #orderDate#,
        </isNotEmpty>
        LastUpdateDate = now()
        WHERE ExchangeOrderID = #exchangeOrderId# AND Status = #preStatus#
    </update>

    <select id="loadExchangeOrderByOrderId" parameterClass="map" resultMap="exchangeOrder">
        <![CDATA[
        select ExchangeOrderID,OrderAmount,OrderType,BankAccountNo,BankAccountName,BankName,BankProvince,
                     BankCity,Status,OrderDate,AddDate,LastUpdateDate,Memo
        from FS_ExchangeOrder
        where ExchangeOrderID = #exchangeOrderId#
        ]]>
    </select>

    <select id="paginateExchangeOrderList" resultMap="exchangeOrderDisplayData" parameterClass="map">
        SELECT
        eo.ExchangeOrderID,
        sa.CustomerGlobalID,
        sa.CompanyGlobalID,
        sa.ShopID,
        eo.OrderAmount,
        eo.BankAccountNo,
        eo.BankAccountName,
        eo.BankName,
        eo.BankProvince,
        eo.BankCity,
        eo.Status,
        eo.Memo,
        eo.AddDate
        FROM
        FS_ExchangeOrder eo
        LEFT JOIN FS_ShopFundAccountFlow flow ON eo.ExchangeOrderID = flow.ExchangeOrderID
        LEFT JOIN FS_ShopFundAccount sa ON flow.FAID = sa.FAID
        <dynamic prepend="WHERE">
            <isGreaterThan property="searchBean.exchangeOrderId" compareValue="0" prepend="and">
                eo.ExchangeOrderID = #searchBean.exchangeOrderId#
            </isGreaterThan>
            <isNotNull property="searchBean.beginDate" prepend="and">
                eo.OrderDate &gt;= #searchBean.beginDate#
            </isNotNull>
            <isNotNull property="searchBean.endDate" prepend="and">
                eo.OrderDate &lt;= #searchBean.endDate#
            </isNotNull>
            <isGreaterThan property="searchBean.status" compareValue="0" prepend="and">
                eo.Status = #searchBean.status#
            </isGreaterThan>
        </dynamic>
        GROUP BY
        eo.ExchangeOrderID,
        sa.CustomerGlobalID,
        sa.CompanyGlobalID,
        sa.ShopID,
        eo.OrderAmount,
        eo.BankAccountNo,
        eo.BankAccountName,
        eo.BankName,
        eo.BankProvince,
        eo.BankCity,
        eo.Status,
        eo.Memo,
        eo.OrderDate
        ORDER BY eo.AddDate DESC, eo.ExchangeOrderID ASC
    </select>

    <select id="paginateExchangeOrderList_COUNT" resultClass="int" parameterClass="map">
        SELECT COUNT(1)
        FROM (
            SELECT 1
            FROM
            FS_ExchangeOrder eo
            LEFT JOIN FS_ShopFundAccountFlow flow ON eo.ExchangeOrderID = flow.ExchangeOrderID
            LEFT JOIN FS_ShopFundAccount sa ON flow.FAID = sa.FAID
            <dynamic prepend="WHERE">
                <isGreaterThan property="searchBean.exchangeOrderId" compareValue="0" prepend="and">
                    eo.ExchangeOrderID = #searchBean.exchangeOrderId#
                </isGreaterThan>
                <isNotNull property="searchBean.beginDate" prepend="and">
                    eo.OrderDate &gt;= #searchBean.beginDate#
                </isNotNull>
                <isNotNull property="searchBean.endDate" prepend="and">
                    eo.OrderDate &lt;= #searchBean.endDate#
                </isNotNull>
                <isGreaterThan property="searchBean.status" compareValue="0" prepend="and">
                    eo.Status = #searchBean.status#
                </isGreaterThan>
            </dynamic>
            GROUP BY
            eo.ExchangeOrderID,
            sa.CustomerGlobalID,
            sa.CompanyGlobalID,
            sa.ShopID,
            eo.OrderAmount,
            eo.BankAccountNo,
            eo.BankAccountName,
            eo.BankName,
            eo.BankProvince,
            eo.BankCity,
            eo.Status,
            eo.Memo,
            eo.OrderDate
            ORDER BY eo.AddDate DESC, eo.ExchangeOrderID ASC
        ) A
    </select>


    <select id="findExchangeOrderTotalAmount" resultClass="java.math.BigDecimal" parameterClass="map">
        SELECT
        IFNULL(SUM(eo.OrderAmount), 0) AS totalAmount
        FROM
        FS_ExchangeOrder eo
        <dynamic prepend="WHERE">
            <isGreaterThan property="searchBean.exchangeOrderId" compareValue="0" prepend="and">
                eo.ExchangeOrderID = #searchBean.exchangeOrderId#
            </isGreaterThan>
            <isNotNull property="searchBean.beginDate" prepend="and">
                eo.OrderDate &gt;= #searchBean.beginDate#
            </isNotNull>
            <isNotNull property="searchBean.endDate" prepend="and">
                eo.OrderDate &lt;= #searchBean.endDate#
            </isNotNull>
            <isGreaterThan property="searchBean.status" compareValue="0" prepend="and">
                eo.Status = #searchBean.status#
            </isGreaterThan>
        </dynamic>
    </select>

    <select id="findExchangeOrderList" resultMap="exchangeOrderDisplayData" parameterClass="map">
        SELECT
        eo.ExchangeOrderID,
        sa.CustomerGlobalID,
        sa.CompanyGlobalID,
        sa.ShopID,
        eo.OrderAmount,
        eo.BankAccountNo,
        eo.BankAccountName,
        eo.BankName,
        eo.BankProvince,
        eo.BankCity,
        eo.Status,
        eo.Memo,
        eo.AddDate
        FROM
        FS_ExchangeOrder eo
        LEFT JOIN FS_ShopFundAccountFlow flow ON eo.ExchangeOrderID = flow.ExchangeOrderID
        LEFT JOIN FS_ShopFundAccount sa ON flow.FAID = sa.FAID
        <dynamic prepend="WHERE">
            <isGreaterThan property="searchBean.exchangeOrderId" compareValue="0" prepend="and">
                eo.ExchangeOrderID = #searchBean.exchangeOrderId#
            </isGreaterThan>
            <isNotNull property="searchBean.beginDate" prepend="and">
                eo.OrderDate &gt;= #searchBean.beginDate#
            </isNotNull>
            <isNotNull property="searchBean.endDate" prepend="and">
                eo.OrderDate &lt;= #searchBean.endDate#
            </isNotNull>
            <isGreaterThan property="searchBean.status" compareValue="0" prepend="and">
                eo.Status = #searchBean.status#
            </isGreaterThan>
        </dynamic>
        GROUP BY
        eo.ExchangeOrderID,
        sa.CustomerGlobalID,
        sa.CompanyGlobalID,
        sa.ShopID,
        eo.OrderAmount,
        eo.BankAccountNo,
        eo.BankAccountName,
        eo.BankName,
        eo.BankProvince,
        eo.BankCity,
        eo.Status,
        eo.Memo,
        eo.OrderDate
        ORDER BY eo.AddDate DESC, eo.ExchangeOrderID ASC
    </select>

    <update id="updateExchangeOrderToPending" parameterClass="map">
        UPDATE FS_ExchangeOrder
        SET Status = #setStatus#,
        LastUpdateDate = now()
        WHERE Status != #whereStatus#
        <isNotEmpty prepend="and" property="orderIds">
            ExchangeOrderID IN
            <iterate open="(" close=")" conjunction="," property="orderIds">
                #orderIds[]#
            </iterate>
        </isNotEmpty>
    </update>
</sqlMap>